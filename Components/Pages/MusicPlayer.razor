@page "/musicplayer/{playlistID}/{refCode}"

@using Microsoft.AspNetCore.SignalR
@using Microsoft.Net.Http.Headers
@using SpotifyAPI.Web
@using SpotifyAPI;
@using Swan.Threading
@using Microsoft.AspNetCore.WebUtilities;
@using System.Diagnostics.Eventing.Reader
@rendermode InteractiveServer
@inject IConfiguration Configuration
@inject NavigationManager NavigationManager

<button class="button-17" role="button" @onclick="() => NavigateToPlaylist(playlistID)">Back to playlist</button>
<div class="text-center"><br /></div>
    <div class="text-center">
        <div style="left: 0; width: 100%; height: 352px; position: relative;">
            <iframe src="https://open.spotify.com/embed/track/@refCode?:play/" 
                    style="top: 0; left: 0; width: 100%; height: 100%; position: absolute; border: 0;" 
                    allowfullscreen
                    allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture;"
                    loading="lazy"
                    async>
            </iframe>
        </div>
    </div>
<div class="text-center"><br /></div>

@if (@refCode == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="song-title">
        <p>Song Title: <em>@songTitle</em></p>
        <p>Artist: <em>@songArtist</em></p>
    </div>

}



@code {
    [Parameter]    
    public String playlistID{ get; set; }
    [Parameter] 
    public String refCode{ get; set; }
    private String songTitle = "Loading";
    private String songArtist = "Loading";
    private String songImg = "Loading";

   protected override async Task OnInitializedAsync()
    {

        //await Task.Delay(1);
        GetSongInfo();
    }

    private async void GetSongInfo() 
    {
        var config = SpotifyClientConfig.CreateDefault();

        var request = new ClientCredentialsRequest(@Configuration["Spotify:CLIENT_ID"], @Configuration["Spotify:SECRET"]);

        var response = await new OAuthClient(config).RequestToken(request);

        var spotify = new SpotifyClient(response);

        var track = await spotify.Tracks.Get(refCode);

        songTitle = track.Name;

        songArtist = track.Album.Artists.FirstOrDefault().Name;

        StateHasChanged();
    }

    private void NavigateToPlaylist(String playlistID)
    {
        NavigationManager.NavigateTo($"/playlist/{playlistID}");
    }
    
}
